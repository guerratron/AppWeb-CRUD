<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: api.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: api.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// AUTO-CARGA LA CLASE "Table"
/*(function () {
    let head = document.querySelector("head");
    let script = document.createElement("script");
    script.setAttribute("type", "text/javascript");
    script.setAttribute("defer", true);
    script.setAttribute("src", "validation.js");
    head.appendChild(script);
})();*/

import {protocol, host, port, path} from "./conex_conf.js"
import UTILS from "./utils.js"
import {Table} from "./Table.js"

/** 2 registros de ejemplo */
const _JSON_DEFAULT1 = {
    regs: [
        {id: 0, nombre: "Ang√©lica", apellido1: "Garc√≠a", apellido2: "L√≥pez", telefono: "600000001", email: "angelica@dominio.com", notas: "Cliente inicial"},
        {id: 1, nombre: "Aniceto", apellido1: "C√°ceres", apellido2: "D√≠az", telefono: "600000002", email: "aniceto@dominio.com", notas: "VIP"}
    ]
};

/* ClientsAPI - by GuerraTron-25, 
 * Se encarga de toda la l√≥gica de la p√°gina y la comunicaci√≥n con el server */
export class ClientsAPI{
    "use strict";

    static contador = 0; //variable est√°tica

    btnSubmit;
    chkSearch;
    btnClean;
    action = "";
    regs = _JSON_DEFAULT1.regs; //[] , typeof _JSON_DEFAULT1.regs
    error = "";
    searches = [];
    
    //CLASE PRINCIPAL
    /** Crea una Table HTML interactiva, con las celdas editables para la actualizaci√≥n a trav√©s de AJAX 
     * del listado de clientes. Y controla las llamadas CRUD al Server, y sus valores de retorno.
     * @param _table_container {HTMLElement | String} Admite una tabla como contenedor (puede ser un id)
     * @param _options {Object} Objeto con las opciones pertinentes
     */
    constructor(_table_container, _options) {
        this.id = ClientsAPI.contador++;
        if(!_table_container){
            this.table_container = document.createElement("table");
            document.body.appendChild(this.table_container);
        }else{
            this.table_container = _table_container.appendChild ? _table_container : document.querySelector(_table_container);
        }

        let _this = this;
        this.options = Object.assign({
            background: "white",
            style: "",
            formAdd: null, //REPRESENTA UN FORMULARIO EXTERNO PARA INSERTAR
            json: []// _this.regs
        }, _options || {});
        this.json = this.options.json;
        this.formAdd = this.options.formAdd;
        if(this.formAdd){
            this.chkSearch = this.formAdd.chkSearch;
            this.chkSearch.addEventListener("change", (ev) => {
                if (this.chkSearch.checked) {
                    this.formAdd.telefono.setAttribute("disabled", true);
                    this.formAdd.notas.setAttribute("disabled", true);
                } else {
                    this.formAdd.telefono.removeAttribute("disabled");
                    this.formAdd.notas.removeAttribute("disabled");
                }
            });
            this.btnClean = this.formAdd.btnClean;
            this.btnClean.addEventListener("click", (ev) => {
                ev.stopPropagation();
                ev.preventDefault();
                this.chkSearch.checked = false;
                if (this.chkSearch.checked) {
                    this.formAdd.telefono.setAttribute("disabled", true);
                    this.formAdd.notas.setAttribute("disabled", true);
                } else {
                    this.formAdd.telefono.removeAttribute("disabled");
                    this.formAdd.notas.removeAttribute("disabled");
                }
                this.formAdd.nombre.value = "";
                this.formAdd.apellido1.value = "";
                this.formAdd.apellido2.value = "";
                this.formAdd.email.value = "";
                this.formAdd.telefono.value = "";
                this.formAdd.notas.value = "";
                this.setList();
            });
            //return false;
            Array.from(this.formAdd.elements).forEach((f)=>{
                if(["nombre", "apellido1", "apellido2", "email"].includes(f.id)){
                    f.addEventListener("change", () => {
                        // se difieren las acciones para no ralentizar el evento "change"
                        setTimeout(() => {
                            let value = VAL.check(f.id, f.value);
                            if (!value) {
                                alert(`üí• Valor para "${this.name}" NO V√ÅLIDO!`);
                                f.value = "";
                            }
                        }, 200);
                    });
                }
            });
            // route + submit
            this.formAdd.action = `${protocol}://${host}:${port}/${path}clients.php`;//?action=add&amp;`;
            this.btnSubmit = this.formAdd.submit;
            this.btnSubmit.addEventListener("click", (ev) => {
                ev.stopPropagation();
                ev.preventDefault();
                let _stop = false;
                Array.from(this.formAdd.elements).forEach((f) => {
                    if (["nombre", "apellido1", "apellido2", "email"].includes(f.id)) {
                        if(!f.value){ _stop = true; }
                    }
                });
                if(!_stop){
                    console.log("se env√≠a a Ajax a√±adiendole la queryString");
                    const datosFormulario = new FormData(this.formAdd);
                    if (this.chkSearch.checked) {
                        console.log(this.datosFormulario, UTILS.formData2json(datosFormulario));
                        this.setSearch(UTILS.formData2json(datosFormulario));
                    } else { //`${this.formAdd.action}?action=insert`
                        this.setInsert(UTILS.formData2json(datosFormulario));
                    }
                }else{
                    alert(`üí• Comprobar Valores. Alguno Requerido Vac√≠o!`);
                }
            });
        }

        this.table = new Table(this, this.options);

        this.loading = document.createElement("img");
        this.loading.src = "loading.gif";
        this.loading.setAttribute("style", "width: 25%; margin:auto; position:absolute; bottom:-50%; left:38%;");
        //this.loading.classList.add("hidden");
        this.table.tdf.appendChild(this.loading);

        this.setList();
    }

    checkRequired(json, msg = ""){
        let check = json.nombre &amp;&amp; json.apellido1 &amp;&amp; json.apellido2 &amp;&amp; json.email;
        if(!check){
            console.log(`${msg} Faltan campos obligatorios`);
            this.setMsg(` ‚ùó ${msg} ! Faltan campos obligatorios`);
            return false;
        }
        return check;
    }

    /** recibe la respuesta de la llamada AJAX y actualiza los registros (o los recrea) de la Tabla */
    update(arrJson = []){
        if(arrJson.length > 0){
            this.table.reset(); //la resetea y recrea para quedarla limpia
            arrJson.forEach((reg)=>{
                //console.log(reg);
                this.table.addReg(reg);
            });
        }
    }

    /** Obtiene el registro para actualizar en el formato json:  
     * {
     *      id: 0, 
     *      fields: {
                apellido1: "Garc√≠a"
                apellido2: "L√≥pez2"
                email: "angelica@dominio.com"
                nombre: "Ang√©lica"
                notas: "Cliente inicial"
                telefono: "600000001"
            }
        }
        Se debe lanzar una llamada AJAX para actualizar la BD
     */
    setOk(json) { //sin√≥nimo de update
        //adaptamos el json al nuevo formato que necesitan las consultas de la BD
        let newJson = {};
        for(let k of Object.keys(json.fields)){
            newJson[k] = json.fields[k];
        }
        console.log("Update Reg ?: ", json);
        this.action = "update";
        this.loading.classList.remove("hidden");
        if (!this.checkRequired(newJson, "Actualizaci√≥n CANCELADA ")) {
            return false;
        }
        let result = confirm(`‚úíÔ∏è ACTUALIZAR REGISTRO ‚ùó ‚ùï\n\n Desea actualizar el registro con 'id=${json.id}' ‚ùì‚ùì`);
        if (result) {
            console.log(`OK, orden de actualizar el registro con 'id=${json.id}'`, result);
            this.setAJAX(`${protocol}://${host}:${port}/${path}clients.php?action=update&amp;`, newJson);
        } else {
            console.log(`Actualizaci√≥n del registro con 'id=${json.id}' CANCELADA !`);
            this.setMsg(`Actualizaci√≥n del registro con 'id=${json.id}' CANCELADA !`);
        }
    }
    setList() {
        console.log("List Reg");
        this.action = "list";
        this.loading.classList.remove("hidden");
        console.log(`OK, orden de listar todos los registros de la BD`);
        this.setMsg(`OK. Listado de Clientes en proceso..`);
        this.setAJAX(`${protocol}://${host}:${port}/${path}clients.php?action=list&amp;`, {});
    }
    /** necesita 4 campos: nombre, apellido1, apellido2 y email */
    setSearch(json) {
        this.action = "search";
        this.loading.classList.remove("hidden");
        console.log("Search Regs");
        console.log(`OK, orden de buscar todos los clientes que cumplan la condici√≥n`, json);
        this.setMsg(`OK. Realiz√°ndose busqueda..`);
        this.setAJAX(`${protocol}://${host}:${port}/${path}clients.php?action=search&amp;`, json);
    }
    /** INSERTAR */
    setInsert(json) {
        this.action = "insert";
        this.loading.classList.remove("hidden");
        if (!this.checkRequired(json, "Inserci√≥n CANCELADA ")) {
            return false;
        }
        //console.log("Delete Reg: " + id + " ?");
        let result = confirm(`üöÄ INSERTAR REGISTRO \n\n Insertar un nuevo registro ‚ùì‚ùì`);
        console.log("Result: ", result);
        if (result) {
            console.log(`OK, orden de insertar un nuevo registro`, result);
            this.setMsg(`OK. Insertar en proceso..`);
            //this.setAJAX(`${protocol}://${host}:${port}/${path}clients.php?action=del&amp;`, json);
            this.setAJAX(`${protocol}://${host}:${port}/${path}clients.php?action=insert&amp;`, json);
        } else {
            console.log(`Nuevo Registro CANCELADO !`);
            this.setMsg(`Nuevo Registro CANCELADO !`)
        }
    }
    /** Se debe lanzar una llamada AJAX para eliminar el registro por 'id' en la BD */
    setDelete(id) {
        this.action = "del";
        this.loading.classList.remove("hidden");
        //console.log("Delete Reg: " + id + " ?");
        let result = confirm(`üí£ ELIMINAR REGISTRO ‚ùó ‚ùï\n\n Seguro que desea eliminar el registro con 'id=${id}' ‚ùì‚ùì`);
        console.log("Result: ", result);
        if(result){
            console.log(`OK, orden de eliminar el registro con 'id=${id}'`, result);
            this.setAJAX(`${protocol}://${host}:${port}/${path}clients.php?action=del&amp;`, {"id": id});
            //this.setAJAX(`${protocol}://${host}:${port}/${path}clients.php?action=${action}&amp;`, json);
        }else{
            console.log(`Elimnaci√≥n del registro con 'id=${id}' CANCELADA !`);
            this.setMsg(`Elimnaci√≥n del registro con 'id=${id}' CANCELADA !`)
        }
    }

    setMsg(msg, style = "background: whiteSmoke; color: #333;") {
        this.loading.classList.add("hidden");
        this.table.setMsg(msg, style);
    }

    /** Solicitud a trav√©s de AJAX a la direcci√≥n proporcionada, con respuesta as√≠ncrona. */
    setAJAX(url, json = {}){
        console.log("1.Enviando a: " + url, json);
        url += (/\?/.test(url) ? "&amp;" : "?") + new Date().getTime();//permite saltar la cach√©
        let _this = this;
        this.loading.classList.remove("hidden");
        let xhttp = new XMLHttpRequest();
        // seguimiento completado: sea satisfactorio o no
        xhttp.onloadend = function(){ //en este caso mejor que las funciones flecha (no pierde el scope)
            if (this.readyState == 4) {
                if (this.status == 200) {
                    console.log(this.response, this.responseType);//JSON.parse(this.responseText));
                    let style = "background: aquamarine; color: darkGreen;";
                    if(this.response.error){
                        style = "background: yellow; color: red;";
                    }
                    _this.setMsg(this.response.error ? ("‚õî" + this.response.error) : "‚úîÔ∏è OK! consulta satisfecha.", style);
                    _this.error = this.response.error;
                    /*if(_this.action == "search"){
                        _this.searches = this.response.regs;
                        _this.showSearches();
                    }else{*/
                        _this.regs = this.response.regs;
                        _this.update(this.response.regs);
                    //}
                    if (_this.action == "search") {
                        _this.searches = this.response.regs;
                    }
                }else if (this.status == 404) {
                    _this.setMsg("‚òπ 404. Page not found.", "background: yellow; color: red;");
                    location.href = "404.html";
                }else{
                    _this.setMsg(`üí• ${this.status}. Augghttt!, Algo sali√≥ mal!!.`, "background: red; color: yellow;");
                }
            }
        };
        //Content-Type como application/x-www-form-urlencoded
        //xhttp.overrideMimeType("xml/application/json");
        xhttp.timeout = 5000; // l√≠mite de tiempo en milisegundos, 10 segundos
        xhttp.responseType = 'json';
        xhttp.open("POST", url, true);
        // application/x-www-form-urlencoded'); //'application/json; charset=utf-8');
        xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');//para queryString
        //xhttp.send(UTILS.json2formData(json));
        console.log(json, UTILS.json2QueryString(json));
        xhttp.send(UTILS.json2QueryString(json)); //funciona mejor con el t√≠pico queryString
    }

   /** Puede realizarse la misma consulta que con AJAX pero con promesas FETCH (m√°s actual) 
    setFETCH(url, json) {
        console.log("3.Enviando a: " + url);
        //saltar la cach√©
        url += (/\?/.test(url) ? "&amp;" : "?") + new Date().getTime();
        // Ejemplo implementando el metodo POST:
        async function postData(url2 = '', data = {}) {
            // Opciones por defecto estan marcadas con un *
            const response = await fetch(url2, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'no-cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'omit', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'application/json'
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: JSON.stringify(data) // body data type must match "Content-Type" header
            });
            return response.json(); // parses JSON response into native JavaScript objects
        }

        postData(url, {
                answer: 42
            })
            .then(data => {
                console.log(data); // JSON data parsed by `data.json()` call
            });
    } */

}


window["ClientsAPI"] = ClientsAPI;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ClientsAPI_ClientsAPI.html">ClientsAPI</a></li><li><a href="Field_Field.html">Field</a></li><li><a href="Registro_Registro.html">Registro</a></li><li><a href="Table.html">Table</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_BD_FIELDS">_BD_FIELDS</a></li><li><a href="global.html#_JSON_DEFAULT1">_JSON_DEFAULT1</a></li><li><a href="global.html#_check">_check</a></li><li><a href="global.html#_formData2json">_formData2json</a></li><li><a href="global.html#_getElementByVal">_getElementByVal</a></li><li><a href="global.html#_isEmailOK">_isEmailOK</a></li><li><a href="global.html#_isOK">_isOK</a></li><li><a href="global.html#_isTxtOK">_isTxtOK</a></li><li><a href="global.html#_json2QueryString">_json2QueryString</a></li><li><a href="global.html#_json2formData">_json2formData</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Fri Nov 14 2025 16:44:20 GMT+0100 (hora est√°ndar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
